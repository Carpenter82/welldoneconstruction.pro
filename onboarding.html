<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="apple-touch-icon" href="https://welldoneconstruction.link/wp-content/uploads/2025/11/well-done-construction-favicon.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Onboarding | Well Done</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h2>Step 2: Compliance Docs</h2>
    <p>Upload your ID and OSHA card to secure your profile.</p>
    <input type="email" id="email" placeholder="Confirm Email Address" required>
    
    <label>Driver's License (Front)</label>
    <input type="file" id="dl" accept="image/*" capture="camera">
    
    <label>OSHA 10/30 Card</label>
    <input type="file" id="osha" accept="image/*" capture="camera">
    
    <button onclick="uploadFiles()" id="upBtn">Sync to Drive</button>
  </div>
  <script>
    // âœ… UPDATED: Points to your NEW Script URL (ending in ...YKd/exec)
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzgDKD-WxUrdxIPzyNOQ1Re00tZG23RHaiD0FLzs6Lv07YK916vPEMVx3ivYi9IhYKd/exec';
    
    const toBase64 = (f) => new Promise(res => { 
        const r = new FileReader(); 
        r.onload = () => res(r.result.split(',')[1]); 
        r.readAsDataURL(f); 
    });
    
    async function uploadFiles() {
        const em = document.getElementById('email').value;
        const dlFile = document.getElementById('dl').files[0];
        const oshaFile = document.getElementById('osha').files[0];
        
        if(!em || !dlFile || !oshaFile) return alert("All fields required");
        
        const btn = document.getElementById('upBtn');
        btn.disabled = true; 
        btn.innerText = "Syncing Docs...";

        const payload = { 
            action: 'onboard', // Aligned with Code.gs 'onboard'
            email: em, 
            files: [ 
                {data: await toBase64(dlFile), name: 'DL.jpg', folder: '1. Permits'}, 
                {data: await toBase64(oshaFile), name: 'OSHA.jpg', folder: '5. Misc'} 
            ] 
        };

        try {
            // Using no-cors mode is safer for client-side uploads to Apps Script to avoid CORS errors, 
            // though it makes error handling slightly opaque.
            await fetch(scriptURL, { 
                method: 'POST', 
                mode: 'no-cors',
                body: JSON.stringify(payload) 
            });
            
            alert("Documents Secured!"); 
            // Redirect to the portal dashboard
            window.location.href = "portal/index.html?email=" + encodeURIComponent(em);
        } catch(e) { 
            alert("Upload failed. Check your connection."); 
            btn.disabled = false; 
            btn.innerText = "Sync to Drive";
        }
    }
  </script>
</body>
</html>
