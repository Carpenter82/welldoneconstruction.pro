<div id="upload-container">
  <input type="file" id="f" accept="image/*">
  <button id="upBtn" onclick="up()">Upload ID & Activate Account</button>
  <p id="msg" style="display:none; color: orange;">Uploading ID and setting up your payroll... please wait.</p>
</div>

<script>
  async function up() {
    const email = new URLSearchParams(window.location.search).get('email');
    const fileInput = document.getElementById('f');
    const btn = document.getElementById('upBtn');
    const msg = document.getElementById('msg');

    if (!fileInput.files[0]) {
      alert("Please select a file first.");
      return;
    }

    // UI Feedback
    btn.disabled = true;
    btn.innerText = "Processing...";
    msg.style.display = "block";

    const file = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = async () => {
      const b64 = reader.result.split(',')[1];
      
      try {
        await fetch('https://script.google.com/macros/s/AKfycbx3JdShPWsv2leCEdh7Q7ebzbu3HZHXSGJgG3wgeKf7r2vvE-3YKKzHIiEmdTmIRZKg/exec', {
          method: 'POST',
          mode: 'no-cors', // Critical for Google Apps Script redirects
          body: JSON.stringify({
            action: 'upload', 
            email: email, 
            base64: b64, 
            filename: file.name, 
            type: file.type
          })
        });

        // Small delay to allow Google to finish the status update before redirecting
        setTimeout(() => {
          window.location.href = 'portal/index.html?email=' + encodeURIComponent(email);
        }, 1500);

      } catch (err) {
        alert("Upload failed. Please check your connection and try again.");
        btn.disabled = false;
        btn.innerText = "Upload ID";
        msg.style.display = "none";
      }
    };
    
    reader.readAsDataURL(file);
  }
</script>
