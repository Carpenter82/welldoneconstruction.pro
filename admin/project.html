<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispatch Work Order | Well Done</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body { background-color: #f4f7f6; font-family: -apple-system, sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { color: #2e7d32; border-bottom: 2px solid #ef6c00; padding-bottom: 10px; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #333; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn-submit { background-color: #ef6c00; color: white; border: none; padding: 15px; width: 100%; margin-top: 25px; font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .btn-submit:hover { background-color: #d84315; }
        .readonly-field { background-color: #e0e0e0; color: #555; }
    </style>
</head>
<body>

<div class="container">
    <h2>Dispatch Work Order</h2>
    <p>Assigning work to: <strong id="displayEmail">...</strong></p>

    <form id="dispatchForm">
        <input type="hidden" id="workerEmail">

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <label>Job ID (Unique)</label>
                <input type="text" id="jobId" placeholder="e.g. 26-104" required>
            </div>
            <div>
                <label>Budget / Rate</label>
                <input type="text" id="budget" placeholder="$500 or $25/hr">
            </div>
        </div>

        <label>Client Name</label>
        <input type="text" id="clientName" required>

        <label>Street Address / Location</label>
        <input type="text" id="address" placeholder="123 Main St, Reno, NV" required>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <label>Trade Assigned</label>
                <select id="trade">
                    <option>General Labor</option>
                    <option>Carpentry</option>
                    <option>Drywall</option>
                    <option>Painting</option>
                    <option>Plumbing</option>
                    <option>Electrical</option>
                    <option>Maintenance</option>
                </select>
            </div>
            <div>
                <label>Source (Lead)</label>
                <input type="text" id="source" placeholder="e.g. Thumbtack, Referral">
            </div>
        </div>

        <label>Scope of Work / Notes</label>
        <textarea id="notes" rows="4" placeholder="Describe the mission..."></textarea>

        <button type="button" onclick="submitWorkOrder()" class="btn-submit" id="submitBtn">DISPATCH & EMAIL WORKER</button>
        <button type="button" onclick="history.back()" style="background:none; border:none; color:#666; width:100%; margin-top:10px; cursor:pointer;">Cancel</button>
    </form>
</div>

<script>
    // âœ… NEW SCRIPT URL
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzgDKD-WxUrdxIPzyNOQ1Re00tZG23RHaiD0FLzs6Lv07YK916vPEMVx3ivYi9IhYKd/exec';

    // 1. Grab Email from URL
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('prefillEmail');
    
    if(email) {
        document.getElementById('workerEmail').value = email;
        document.getElementById('displayEmail').innerText = email;
    } else {
        alert("No worker selected. Returning to dashboard.");
        window.location.href = 'admin/index.html';
    }

    // 2. Generate Auto Job ID (Optional Helper)
    document.getElementById('jobId').value = "JOB-" + Math.floor(Math.random() * 10000);

    // 3. Submit Logic
    async function submitWorkOrder() {
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "Dispatching...";

        const payload = {
            action: 'dispatchJob',
            email: document.getElementById('workerEmail').value,
            jobId: document.getElementById('jobId').value,
            client: document.getElementById('clientName').value,
            address: document.getElementById('address').value,
            trade: document.getElementById('trade').value,
            budget: document.getElementById('budget').value,
            source: document.getElementById('source').value,
            notes: document.getElementById('notes').value
        };

        try {
            await fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(payload)
            });

            alert("Work Order Sent! Worker has been emailed.");
            window.location.href = 'admin/index.html';
        } catch (e) {
            alert("Error sending order.");
            btn.disabled = false;
            btn.innerText = "DISPATCH & EMAIL WORKER";
        }
    }
</script>
</body>
</html>
