<script>
  const scriptURL = 'https://script.google.com/macros/s/AKfycbyN1uUGRDmEYax-dyv5VB5xpzYGfKdQ8by-uMq82eBBUFjk3ETj9juCd9ax6E5IzWMt/exec';

  async function loadProjects() {
    try {
      const urlParams = new URLSearchParams(window.location.search);
      const filterEmail = urlParams.get('worker');
      const resp = await fetch(`${scriptURL}?action=getProjectLog&t=${Date.now()}`);
      let projects = await resp.json();

      if (filterEmail) {
        projects = projects.filter(p => p.email === filterEmail);
        document.getElementById('pageTitle').innerText = `Projects for ${filterEmail}`;
        document.getElementById('viewAllLink').style.display = 'inline';
      }

      const totalBudget = projects.reduce((sum, p) => {
        const val = String(p.budget || "0").replace(/[^0-9.-]+/g, "");
        return sum + (parseFloat(val) || 0);
      }, 0);

      document.getElementById('totalValueText').innerText = `Total Portfolio Value: $${totalBudget.toLocaleString()}`;

      const body = document.getElementById('projectBody');
      body.innerHTML = projects.reverse().map(p => `
        <tr>
          <td>${new Date(p.timestamp).toLocaleDateString()}</td>
          <td>${p.email}</td>
          <td><strong>${p.clientName}</strong><br><small>${p.location}</small></td>
          <td style="color:#2E7D32; font-weight:bold;">$${p.budget}</td>
          <td><span class="status-badge ${p.status?.toLowerCase() || ''}">${p.status || 'LOGGED'}</span></td>
          <td>${p.mapLink ? `<a href="${p.mapLink}" target="_blank">üìç View</a>` : '‚Äî'}</td>
        </tr>
      `).join('');
    } catch (e) {
      document.getElementById('projectBody').innerHTML = '<tr><td colspan="6">Error loading data.</td></tr>';
    }
  }
  window.onload = loadProjects;
</script>
