<script>
  const scriptURL = 'https://script.google.com/macros/s/AKfycbyN1uUGRDmEYax-dyv5VB5xpzYGfKdQ8by-uMq82eBBUFjk3ETj9juCd9ax6E5IzWMt/exec';

  async function loadActivity() {
    const container = document.getElementById('activityLog');
    try {
      // Cache-buster ensures you see the ping they just sent 10 seconds ago
      const resp = await fetch(`${scriptURL}?action=getActivity&t=${Date.now()}`);
      const logs = await resp.json();
      
      console.log("Activity Data Received:", logs);

      if (!logs || logs.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">No GPS activity recorded yet.</p>';
        return;
      }

      // Latest check-ins at the top
      const reversedLogs = [...logs].reverse();

      container.innerHTML = reversedLogs.map(l => {
        const logDate = l.timestamp ? new Date(l.timestamp).toLocaleString() : "Date Unknown";
        
        // Clean up the email to show the name/prefix if the email is too long
        const displayName = l.email ? l.email.split('@')[0].toUpperCase() : 'UNKNOWN';
        
        return `
          <div class="activity-card" style="border-left: 5px solid #33B26E; margin-bottom:15px; padding:15px; background:white; border-radius:8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
              <div>
                <strong style="color:#2c3e50; font-size:1.1rem;">${displayName}</strong>
                <br>
                <span style="color:#888; font-size:0.85rem;">${l.email}</span>
              </div>
              <span style="background: #e8f5e9; color: #2e7d32; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold;">CHECK-IN</span>
            </div>
            
            <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">
            
            <div style="color:#666; font-size:0.9rem;">üïí ${logDate}</div>
            
            <div style="margin-top:12px;">
              ${l.mapLink && l.mapLink.includes('http') ? 
                `<a href="${l.mapLink}" target="_blank" style="display:inline-block; background:#1976D2; color:white; padding:8px 12px; border-radius:4px; text-decoration:none; font-size:0.85rem; font-weight:bold;">üìç View Location</a>` : 
                `<span style="color:#d32f2f; font-size:0.85rem; font-style:italic;">‚ö†Ô∏è GPS Data Unavailable</span>`}
            </div>
          </div>
        `;
      }).join('');

    } catch (e) {
      console.error("Load Error:", e);
      container.innerHTML = `<div style="text-align:center; padding:20px;">
        <p style="color:red;">‚ö†Ô∏è Error connecting to Activity Logs.</p>
        <button onclick="loadActivity()" style="padding:10px 20px; cursor:pointer;">Retry Connection</button>
      </div>`;
    }
  }

  window.onload = loadActivity;
</script>
