<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="apple-touch-icon" href="https://welldoneconstruction.link/wp-content/uploads/2025/11/well-done-construction-favicon.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crew Management | Well Done</title>
  <link rel="stylesheet" href="../styles.css">
  <style>
    /* Admin Specific Overrides */
    .container { max-width: 900px; margin: 0 auto; padding: 20px; }
    
    .admin-nav { 
      display: flex; 
      justify-content: center; 
      gap: 15px; 
      margin-bottom: 30px; 
      padding: 15px; 
      background: white; 
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .admin-nav a { text-decoration: none; color: var(--wd-slate); font-weight: bold; font-size: 0.9rem; padding: 10px 15px; border-radius: 8px; }
    .admin-nav a.active { color: var(--wd-green); background: #f0fff4; }

    /* Worker Cards */
    .worker-card { 
      background: white; 
      padding: 20px; 
      border-radius: 12px; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.03); 
      margin-bottom: 15px; 
      display: flex; 
      flex-wrap: wrap; /* Helps on mobile */
      justify-content: space-between; 
      align-items: center; 
      border: 1px solid #edf2f7;
    }
    
    .worker-info { flex: 1; min-width: 200px; }
    .worker-info h4 { margin: 0; color: var(--wd-dark); font-size: 1.2rem; }
    .worker-info p { margin: 5px 0 0; color: var(--wd-slate); font-size: 0.9rem; }
    
    .btn-group { 
      display: flex; 
      gap: 10px; 
      flex-wrap: wrap; 
      margin-top: 15px; /* Spacing for mobile stack */
    }

    /* Modal Styling */
    #assignModal { 
      display:none; 
      position:fixed; 
      top:0; left:0; 
      width:100%; height:100%; 
      background:rgba(0,0,0,0.85); 
      z-index:2000; 
      backdrop-filter: blur(5px);
    }
    .modal-box { 
      background:white; 
      max-width:450px; 
      margin:40px auto; 
      padding:30px; 
      border-radius:15px; 
      box-sizing: border-box;
    }
    
    .action-btn { 
      padding: 10px 16px; 
      border-radius: 8px; 
      border: none; 
      font-size: 0.85rem; 
      cursor: pointer; 
      font-weight: bold; 
      text-decoration: none; 
      text-align: center;
    }
    .btn-assign { background: #4A90E2; color: white; }
    .btn-hire { background: var(--wd-green); color: white; }
    .btn-pause { background: #f6ad55; color: white; }
    .btn-folder { background: var(--wd-dark); color: white; }
  </style>
</head>
<body>

<div class="container">
  <div class="admin-nav">
    <a href="index.html" class="active">Crew Roster</a>
    <a href="activity.html">Site Activity Log</a>
  </div>

  <h2 style="text-align: center;">Active Roster</h2>
  <div id="workerList">
    <p style="text-align: center;">Scanning job sites...</p>
  </div>
</div>

<div id="assignModal">
  <div class="modal-box">
  <h3>Assign Project</h3>
  
  <label>Select Worker</label>
  <select id="assignWorkerSelect" style="width: 100%; padding: 10px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #ddd;">
    <option value="">-- Choose a Worker --</option>
  </select>
  
  <input type="hidden" id="assignEmail"> <label>Project Address</label>
  <input type="text" id="jobLocation" placeholder="Street, City, Zip">
  
  <label>Work Scope</label>
  <textarea id="jobScope" rows="4" placeholder="List tasks here..."></textarea>
  
  <label>Pay Details</label>
  <input type="text" id="jobPay" placeholder="e.g. $250 Total">
  
  <button onclick="submitAssignment()" class="btn btn-hire">Send Assignment</button>
  <button onclick="closeAssign()" style="background: none; color: var(--wd-slate); border: none; width: 100%; margin-top: 10px; cursor: pointer;">Cancel</button>
</div>
  <div class="modal-box">
    <h3>Assign Project</h3>
    <p id="assignNameDisplay" style="font-weight: bold; color: var(--wd-green);"></p>
    
    <input type="hidden" id="assignEmail">
    
    <label>Project Address</label>
    <input type="text" id="jobLocation" placeholder="Street, City, Zip">
    
    <label>Work Scope</label>
    <textarea id="jobScope" rows="4" placeholder="List tasks here..."></textarea>
    
    <label>Pay Details</label>
    <input type="text" id="jobPay" placeholder="e.g. $250 Total">
    
    <button onclick="submitAssignment()" class="btn btn-hire">Send Assignment</button>
    <button onclick="closeAssign()" style="background: none; color: var(--wd-slate); border: none; width: 100%; margin-top: 10px; cursor: pointer;">Cancel</button>
  </div>
</div>

<script>
  const scriptURL = 'https://script.google.com/macros/s/AKfycbx3JdShPWsv2leCEdh7Q7ebzbu3HZHXSGJgG3wgeKf7r2vvE-3YKKzHIiEmdTmIRZKg/exec';

  async function loadWorkers() {
    try {
      const resp = await fetch(`${scriptURL}?action=getWorkers&t=${Date.now()}`);
      const workers = await resp.json();
      let html = '';
      
      workers.forEach(w => {
        html += `
          <div class="worker-card">
            <div class="worker-info">
              <h4>${w.name}</h4>
              <p>${w.trade} | <span class="badge status-${w.status.toLowerCase().replace(' ', '-')}">${w.status}</span></p>
            </div>
            <div class="btn-group">
              <button class="action-btn btn-assign" onclick="openAssign('${w.name}', '${w.email}')">Assign</button>
              <a href="${w.folderLink}" target="_blank" class="action-btn btn-folder">Files</a>
              <button class="action-btn btn-hire" onclick="updateStatus(${w.rowIndex}, 'ACTIVE')">Hire</button>
              <button class="action-btn btn-pause" onclick="updateStatus(${w.rowIndex}, 'ON HOLD')">Pause</button>
            </div>
          </div>
        `;
      });
      document.getElementById('workerList').innerHTML = html || '<p>No workers found.</p>';
    } catch (e) {
      document.getElementById('workerList').innerHTML = '<p>Error loading roster.</p>';
    }
  }

  function openAssign(name, email) {
    document.getElementById('assignNameDisplay').innerText = `To: ${name}`;
    document.getElementById('assignEmail').value = email;
    document.getElementById('assignModal').style.display = 'block';
  }

  function closeAssign() { document.getElementById('assignModal').style.display = 'none'; }

  async function submitAssignment() {
    const btn = event.target;
    btn.innerText = "Sending...";
    btn.disabled = true;

    const d = {
      action: 'assignWork',
      email: document.getElementById('assignEmail').value,
      location: document.getElementById('jobLocation').value,
      scope: document.getElementById('jobScope').value,
      pay: document.getElementById('jobPay').value
    };

    await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(d) });
    alert("Project Dispatched!");
    closeAssign();
    btn.innerText = "Send Assignment";
    btn.disabled = false;
  }

  async function updateStatus(row, status) {
    if(!confirm(`Set worker to ${status}?`)) return;
    await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({action: 'updateStatus', row: row, status: status}) });
    loadWorkers(); // Refresh UI
  }

  window.onload = loadWorkers;
</script>
</body>
</html>
async function loadWorkers() {
  try {
    const resp = await fetch(`${scriptURL}?action=getWorkers&t=${Date.now()}`);
    const workers = await resp.json();
    let html = '';
    
    workers.forEach(w => {
      // This builds the card using the data from the script above
      html += `
        <div class="worker-card">
          <div class="worker-info">
            <h4>${w.name}</h4>
            <p>${w.trade} | <span class="badge status-${w.status.toLowerCase().replace(' ', '-')}">${w.status}</span></p>
            <small style="color:#6E797F;">${w.email}</small>
          </div>
          <div class="btn-group">
            <button class="action-btn btn-assign" onclick="openAssign('${w.name}', '${w.email}')">Assign</button>
            <a href="${w.folderLink}" target="_blank" class="action-btn btn-folder">Files</a>
            <button class="action-btn btn-hire" onclick="updateStatus(${w.rowIndex}, 'ACTIVE')">Hire</button>
            <button class="action-btn btn-pause" onclick="updateStatus(${w.rowIndex}, 'ON HOLD')">Pause</button>
          </div>
        </div>
      `;
    });
    document.getElementById('workerList').innerHTML = html || '<p style="text-align:center;">No active workers found.</p>';
  } catch (e) {
    document.getElementById('workerList').innerHTML = '<p style="text-align:center; color:red;">Error loading roster.</p>';
  }
}
