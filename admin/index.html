<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Well Done | Admin Dashboard</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #33B26E;
            --hold: #e74c3c;
            --bg: #f4f7f6;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--primary); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .nav-links a { color: white; text-decoration: none; margin-left: 15px; font-weight: bold; font-size: 0.9rem; }
        
        #workerList { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        
        .worker-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-top: 5px solid var(--accent); }
        .status-hold { border-top-color: var(--hold); opacity: 0.8; }
        
        .worker-info h3 { margin: 0; color: var(--primary); }
        .worker-meta { color: #666; font-size: 0.9rem; margin: 10px 0; }
        .badge { background: #eee; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        
        .worker-actions { margin-top: 15px; display: flex; gap: 8px; flex-wrap: wrap; }
        
        .btn-sm { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold; background: #eee; color: var(--primary); text-decoration: none; }
        .btn-projects { background: var(--primary); color: white; }
        .toggle-btn { background: #34495e; color: white; }
        .btn-sm:hover { filter: brightness(90%); }

        .loading-msg { text-align: center; padding: 50px; color: #666; font-style: italic; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h1 style="margin:0; font-size: 1.5rem;">Well Done Admin</h1>
            <small>Construction Management System</small>
        </div>
        <div class="nav-links">
            <a href="index.html">üè† Roster</a>
            <a href="projects.html">üìã All Projects</a>
            <a href="activity.html">üìç GPS Activity</a>
        </div>
    </div>

    <div id="workerList">
        <div class="loading-msg">üì° Connecting to Google Database...</div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyN1uUGRDmEYax-dyv5VB5xpzYGfKdQ8by-uMq82eBBUFjk3ETj9juCd9ax6E5IzWMt/exec';

        async function loadWorkers() {
            const container = document.getElementById('workerList');
            try {
                const resp = await fetch(`${scriptURL}?action=getWorkers&t=${Date.now()}`);
                const workers = await resp.json();
                
                if (!workers || workers.length === 0) {
                    container.innerHTML = '<div class="worker-card"><h3>No Workers Found</h3><p>Hire someone in the Google Sheet to see them here.</p></div>';
                    return;
                }

                let html = '';
                workers.forEach(w => {
                    const isPaused = w.status === 'PAUSED' || w.status === 'ON HOLD';
                    html += `
                        <div class="worker-card ${isPaused ? 'status-hold' : ''}">
                            <div class="worker-info">
                                <h3>${w.name}</h3>
                                <p class="worker-meta">
                                    <strong>${w.trade}</strong> | <span class="badge">${w.status}</span> | Tier: ${w.tier || 'TBD'}
                                </p>
                                <p style="font-size: 0.8rem; color: #999;">${w.email}</p>
                            </div>
                            <div class="worker-actions">
                                <a href="projects.html?worker=${encodeURIComponent(w.email)}" class="btn-sm btn-projects">üìã Projects</a>
                                <button onclick="assignWork('${w.email}')" class="btn-sm" style="background: #33B26E; color: white;">Assign Work</button>
                                <a href="${w.folderLink}" target="_blank" class="btn-sm">Files</a>
                                <button onclick="updateStatus(${w.rowIndex}, '${isPaused ? 'ACTIVE' : 'PAUSED'}')" class="btn-sm toggle-btn">
                                    ${isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause'}
                                </button>
                            </div>
                        </div>`;
                });
                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = '<p style="color:red; text-align:center;">‚ö†Ô∏è Error connecting to database. Make sure your Google Script is deployed.</p>';
            }
        }

        async function updateStatus(row, newStatus) {
            if(!confirm(`Set status to ${newStatus}?`)) return;
            try {
                await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateStatus', row: row, status: newStatus }) });
                setTimeout(loadWorkers, 1200);
            } catch (e) { alert("Update failed."); }
        }

        async function assignWork(email) {
            // 1. Select the Legal Framework
            const typeChoice = prompt(
                "SELECT WORK ORDER TYPE:\n" +
                "1 - üîç INSPECTION (On-Call Addition)\n" +
                "2 - üõ†Ô∏è SERVICE CALL (On-Call Authorization)\n" +
                "3 - ‚úÖ APPROVED REPAIR (Small Project Safeguard)"
            );

            if (!['1', '2', '3'].includes(typeChoice)) {
                alert("Assignment cancelled: You must select a valid type (1, 2, or 3).");
                return;
            }

            const client = prompt("Enter Client Name:");
            if (!client) return;

            const address = prompt("Enter Street Address:");
            if (!address) return;

            const baseScope = prompt("Describe the specific task:");
            const budget = prompt("Budget Amount ($):");

            // 2. Define the Legal "Protective Wrapper"
            const globalSafeguard = "\n\n--- GLOBAL SAFEGUARDS ---\n" +
                "Total costs shall not exceed $10,000. No full remodels or structural alterations authorized.";

            let typeSpecificClause = "";
            if (typeChoice === '1') {
                typeSpecificClause = "\n\n--- 1Ô∏è‚É£ INSPECTION WORK ORDER ---\n" +
                    "On-Call Service: Inspection findings do not guarantee repair authorization. Limited to one system.";
            } else if (typeChoice === '2') {
                typeSpecificClause = "\n\n--- 2Ô∏è‚É£ SERVICE CALL AUTHORIZATION ---\n" +
                    "Minor corrective work only. Does not convert into renovation or rebuild.";
            } else if (typeChoice === '3') {
                typeSpecificClause = "\n\n--- 3Ô∏è‚É£ APPROVED REPAIR ---\n" +
                    "Single defined task. Authorization expires if scope expands or hits regulatory limits.";
            }

            const finalScope = baseScope.toUpperCase() + typeSpecificClause + globalSafeguard;

            try {
                await fetch(scriptURL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify({ 
                        action: 'assignWork', 
                        email: email, 
                        clientName: client, 
                        location: address, 
                        scope: finalScope, 
                        budget: budget || "$0",
                        source: "Admin Dashboard" 
                    }) 
                });

                alert(`‚úÖ ASSIGNED: ${client} dispatched to ${email}`);
                window.location.href = `projects.html?worker=${encodeURIComponent(email)}`;
            } catch (e) {
                alert("Error: Assignment failed.");
            }
        }

        window.onload = loadWorkers;
    </script>
</body>
</html>
