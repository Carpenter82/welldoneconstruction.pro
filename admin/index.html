<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crew Management | Well Done</title>
  <link rel="stylesheet" href="../styles.css">
  <style>
    .admin-nav { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
    .admin-nav a { text-decoration: none; color: #343E47; font-weight: bold; font-size: 0.9rem; }
    .admin-nav a.active { color: #33B26E; border-bottom: 2px solid #33B26E; }

    .worker-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
    .worker-info h4 { margin: 0; color: #343E47; }
    .worker-info p { margin: 5px 0 0; color: #6E797F; font-size: 0.85rem; }
    
    .btn-group { display: flex; gap: 10px; }
    .action-btn { padding: 8px 12px; border-radius: 4px; border: none; font-size: 0.8rem; cursor: pointer; font-weight: bold; text-decoration: none; text-align: center; }
    .btn-assign { background: #4A90E2; color: white; }
    .btn-hire { background: #33B26E; color: white; }
    .btn-folder { background: #343E47; color: white; }

    /* Modal Styling */
    #assignModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; }
    .modal-box { background:white; max-width:500px; margin:50px auto; padding:25px; border-radius:8px; }
    .modal-box input, .modal-box textarea { width: 100%; margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
  </style>
</head>
<body>

<div class="container" style="max-width: 900px; margin: 0 auto; padding: 20px;">
  <div class="admin-nav">
    <a href="index.html" class="active">Crew Management</a>
    <a href="activity.html">Site Activity Log</a>
  </div>

  <h2 style="text-align: center;">Crew Roster</h2>
  <div id="workerList">Loading workers...</div>
</div>

<div id="assignModal">
  <div class="modal-box">
    <h3>Assign Project: <span id="assignName"></span></h3>
    <input type="hidden" id="assignEmail">
    
    <label>Project Address:</label>
    <input type="text" id="jobLocation" placeholder="e.g. 123 Main St, Reno">
    
    <label>Scope of Work:</label>
    <textarea id="jobScope" placeholder="Tasks to be completed..."></textarea>
    
    <label>Pay Rate:</label>
    <input type="text" id="jobPay" placeholder="e.g. $250 Flat Rate">
    
    <button onclick="submitAssignment()" class="action-btn btn-hire" style="width: 100%; margin-bottom: 10px; height: 45px;">Send Assignment</button>
    <button onclick="closeAssign()" class="action-btn" style="width: 100%; background: #eee;">Cancel</button>
  </div>
</div>

<script>
  const scriptURL = 'https://script.google.com/macros/s/AKfycbx3JdShPWsv2leCEdh7Q7ebzbu3HZHXSGJgG3wgeKf7r2vvE-3YKKzHIiEmdTmIRZKg/exec';

  async function loadWorkers() {
    const resp = await fetch(scriptURL + '?action=getWorkers');
    const workers = await resp.json();
    let html = '';
    
    workers.forEach(w => {
      html += `
        <div class="worker-card">
          <div class="worker-info">
            <h4>${w.name}</h4>
            <p>${w.trade} | Status: <strong>${w.status}</strong></p>
          </div>
          <div class="btn-group">
            <button class="action-btn btn-assign" onclick="openAssign('${w.name}', '${w.email}')">Assign</button>
            <a href="${w.folderLink}" target="_blank" class="action-btn btn-folder">Folder</a>
            <button class="action-btn btn-hire" onclick="updateStatus(${w.rowIndex}, 'ACTIVE')">Hire</button>
          </div>
        </div>
      `;
    });
    document.getElementById('workerList').innerHTML = html;
  }

  function openAssign(name, email) {
    document.getElementById('assignName').innerText = name;
    document.getElementById('assignEmail').value = email;
    document.getElementById('assignModal').style.display = 'block';
  }

  function closeAssign() { document.getElementById('assignModal').style.display = 'none'; }

  async function submitAssignment() {
    const data = {
      action: 'assignWork',
      name: document.getElementById('assignName').innerText,
      email: document.getElementById('assignEmail').value,
      location: document.getElementById('jobLocation').value,
      scope: document.getElementById('jobScope').value,
      pay: document.getElementById('jobPay').value
    };
    await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
    alert("Assignment Sent to Worker and Contract Folder!");
    closeAssign();
  }

  async function updateStatus(row, status) {
    await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({action: 'updateStatus', row: row, status: status}) });
    alert("Status Updated!");
    loadWorkers();
  }

  window.onload = loadWorkers;
</script>
</body>
</html>
