<!DOCTYPE html>
<html>
<head>
    <title>Daily Accountability Checklist</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <div class="container">
        <h2>Site Accountability</h2>
        <p id="workerName">Loading worker profile...</p>
        <hr>

        <div id="tasklist">
            <label><input type="checkbox" class="task"> Site Cleaned & Debris Removed</label><br>
            <label><input type="checkbox" class="task"> Materials Organized/Staged</label><br>
            <label><input type="checkbox" class="task"> Photo Documentation Uploaded</label><br>
            <label><input type="checkbox" class="task"> Safety Check Completed</label><br>
        </div>

        <button id="checkInBtn" onclick="getLocation()" style="margin-top:20px; background:#33B26E; color:white; padding:15px; width:100%; border:none; border-radius:5px;">
            Verify Location & Submit Checklist
        </button>

        <p id="statusMsg" style="color:orange; font-weight:bold;"></p>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');
        const scriptURL = 'https://script.google.com/macros/s/AKfycbx3JdShPWsv2leCEdh7Q7ebzbu3HZHXSGJgG3wgeKf7r2vvE-3YKKzHIiEmdTmIRZKg/exec';

        if (!email) {
            alert("No worker email detected. Please log in via the Portal.");
            window.location.href = "../portal/index.html";
        }

        function getLocation() {
            const btn = document.getElementById('checkInBtn');
            const msg = document.getElementById('statusMsg');
            
            // Check if all boxes are checked
            const tasks = document.querySelectorAll('.task');
            const allChecked = Array.from(tasks).every(t => t.checked);
            
            if (!allChecked) {
                alert("Please complete all checklist items first.");
                return;
            }

            btn.disabled = true;
            msg.innerText = "Acquiring GPS Signal...";

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(sendData, (err) => {
                    alert("Error: Location access denied. Please enable GPS.");
                    btn.disabled = false;
                });
            }
        }

        async function sendData(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            
            await fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({
                    action: 'checkin',
                    email: email,
                    lat: lat,
                    lng: lng
                })
            });

            document.getElementById('statusMsg').innerText = "Check-in Successful! Redirecting to Portal...";
            setTimeout(() => {
                window.location.href = `../portal/index.html?email=${email}`;
            }, 2000);
        }
    </script>
</body>
</html>
