<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="apple-touch-icon" href="https://welldoneconstruction.link/wp-content/uploads/2025/11/well-done-construction-favicon.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Site Checklist | Well Done Construction</title>
  <style>
    :root { --primary: #2c3e50; --accent: #33B26E; --bg: #f4f7f6; }
    body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
    .container { max-width: 500px; margin: 0 auto; padding: 20px; }
    .task-item { display: flex; align-items: center; background: #fff; padding: 20px; margin-bottom: 15px; border-radius: 12px; cursor: pointer; border: 2px solid #eee; }
    .task-item input[type="checkbox"] { width: 25px; height: 25px; margin-right: 15px; }
    .photo-section { background: white; padding: 20px; border-radius: 12px; border: 2px dashed #ccc; text-align: center; margin-bottom: 15px; cursor: pointer; }
    #preview { width: 100%; border-radius: 8px; margin-top: 10px; display: none; }
    .btn { width: 100%; background: var(--accent); color: white; padding: 18px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; }
    .btn:disabled { background: #ccc; }
    #statusMsg { text-align: center; margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>

<div class="container">
  <h2 style="text-align: center;">Daily Site Checklist</h2>
  
  <div id="checklist">
    <label class="task-item"><input type="checkbox" class="task"> <span>Work area cleared of debris</span></label>
    <label class="task-item"><input type="checkbox" class="task"> <span>All tools accounted for</span></label>
    <label class="task-item"><input type="checkbox" class="task"> <span>Site secured / locked up</span></label>
  </div>

  <div class="photo-section" onclick="document.getElementById('sitePhoto').click()">
    <p id="uploadText">ðŸ“¸ Tap to Take Completion Photo</p>
    <input type="file" id="sitePhoto" accept="image/*" capture="camera" style="display: none;">
    <img id="preview" alt="Site Preview">
  </div>

  <button id="submitBtn" class="btn" onclick="submitChecklist()">Submit & Verify GPS</button>
  <p id="statusMsg"></p>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const email = urlParams.get('email');
  
  // UPDATED TO YOUR NEW ACTIVE URL
  const scriptURL = 'https://script.google.com/macros/s/AKfycbzQT7DP6beojo_8pcOP3VFPcsBhvxI1nUYxbUQvThdnWuMvw8InEogp2TwoKS9RQ_M5/exec';

  document.getElementById('sitePhoto').onchange = function(e) {
    const reader = new FileReader();
    reader.onload = function() {
      const preview = document.getElementById('preview');
      preview.src = reader.result;
      preview.style.display = 'block';
      document.getElementById('uploadText').innerText = "âœ… Photo Captured";
    }
    reader.readAsDataURL(e.target.files[0]);
  };

  async function submitChecklist() {
    const tasks = document.querySelectorAll('.task');
    const allChecked = Array.from(tasks).every(t => t.checked);
    const photoFile = document.getElementById('sitePhoto').files[0];
    const btn = document.getElementById('submitBtn');
    const msg = document.getElementById('statusMsg');

    if (!allChecked || !photoFile) {
      alert("Please complete all tasks and take a photo.");
      return;
    }

    if (!email) {
      alert("Error: No worker email found. Please access this via the Portal.");
      return;
    }

    btn.innerText = "Verifying Location & Uploading...";
    btn.disabled = true;

    navigator.geolocation.getCurrentPosition(async (pos) => {
      const reader = new FileReader();
      reader.onload = async function() {
        const base64Data = reader.result.split(',')[1];
        
        const payload = {
          action: 'uploadJobPhoto',
          email: email,
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          fileData: base64Data,
          category: "COMPLETION_CHECKLIST"
        };

        try {
          // Standard fetch (removes no-cors)
          await fetch(scriptURL, { method: 'POST', body: JSON.stringify(payload) });

          msg.style.color = "green";
          msg.innerText = "âœ“ Site Cleared & Verified!";
          
          setTimeout(() => {
            window.location.href = `../portal/index.html?email=${encodeURIComponent(email)}`;
          }, 2000);

        } catch (err) {
          alert("Error uploading. Try again.");
          btn.disabled = false;
          btn.innerText = "Submit & Verify GPS";
        }
      };
      reader.readAsDataURL(photoFile);
    }, (err) => {
      alert("GPS required to complete checklist.");
      btn.disabled = false;
      btn.innerText = "Submit & Verify GPS";
    }, { enableHighAccuracy: true });
  }
</script>
</body>
</html>
