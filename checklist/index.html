<script>
  const urlParams = new URLSearchParams(window.location.search);
  const email = urlParams.get('email');
  const jobId = urlParams.get('jobId') || "N/A";
  
  document.getElementById('jobDisplay').innerText = `Current Job: #${jobId}`;

  // Ensure this matches your latest deployment URL
  const scriptURL = 'https://script.google.com/macros/s/AKfycbyN1uUGRDmEYax-dyv5VB5xpzYGfKdQ8by-uMq82eBBUFjk3ETj9juCd9ax6E5IzWMt/exec';

  document.getElementById('sitePhoto').onchange = function(e) {
    const reader = new FileReader();
    reader.onload = function() {
      const preview = document.getElementById('preview');
      preview.src = reader.result;
      preview.style.display = 'block';
      document.getElementById('uploadText').innerText = "✅ PHOTO READY";
    }
    if(e.target.files[0]) reader.readAsDataURL(e.target.files[0]);
  };

  async function submitChecklist() {
    const tasks = document.querySelectorAll('.task');
    const allChecked = Array.from(tasks).every(t => t.checked);
    const photoFile = document.getElementById('sitePhoto').files[0];
    const btn = document.getElementById('submitBtn');
    const msg = document.getElementById('statusMsg');

    if (!allChecked || !photoFile) {
      alert("Mandatory: Check all boxes and take a photo before leaving.");
      return;
    }

    btn.innerText = "UPDATING DISPATCH...";
    btn.disabled = true;

    navigator.geolocation.getCurrentPosition(async (pos) => {
      const reader = new FileReader();
      reader.onload = async function() {
        const base64Data = reader.result.split(',')[1];
        
        // FIXED: action must be 'logGPS' and type 'completion' to match your Apps Script
        const payload = {
          action: 'logGPS',
          type: 'completion',
          email: email,
          jobId: jobId,
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          fileData: base64Data,
          fileName: `Completion_${jobId}_${email.split('@')[0]}.jpg`
        };

        try {
          // Use mode: 'no-cors' to avoid browser blocks
          await fetch(scriptURL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify(payload) 
          });
          
          msg.style.color = "green";
          msg.innerText = "✓ Site Verified! Redirecting...";
          
          setTimeout(() => {
            window.location.href = `../portal/dashboard.html?email=${encodeURIComponent(email)}`;
          }, 2000);

        } catch (err) {
          alert("Network error. Please try again.");
          btn.disabled = false;
          btn.innerText = "SUBMIT & VERIFY GPS";
        }
      };
      reader.readAsDataURL(photoFile);
    }, (err) => {
      alert("GPS Permission Denied. You must enable location to verify completion.");
      btn.disabled = false;
      btn.innerText = "SUBMIT & VERIFY GPS";
    }, { enableHighAccuracy: true });
  }
</script>
