<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="apple-touch-icon" href="https://welldoneconstruction.link/wp-content/uploads/2025/11/well-done-construction-favicon.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Site Checklist | Well Done Construction</title>
  <style>
    :root { --primary: #2c3e50; --accent: #33B26E; --bg: #f4f7f6; }
    body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
    .container { max-width: 500px; margin: 0 auto; padding: 20px; }
    h2 { text-align: center; color: var(--primary); margin-bottom: 5px; }
    .job-badge { text-align: center; font-weight: bold; font-size: 0.9rem; color: #666; margin-bottom: 25px; }
    
    .task-item { display: flex; align-items: center; background: #fff; padding: 20px; margin-bottom: 15px; border-radius: 12px; cursor: pointer; border: 2px solid #eee; transition: 0.2s; }
    .task-item:active { background: #f9f9f9; }
    .task-item input[type="checkbox"] { width: 25px; height: 25px; margin-right: 15px; accent-color: var(--accent); }
    
    .photo-section { background: white; padding: 30px 20px; border-radius: 12px; border: 2px dashed #ccc; text-align: center; margin-bottom: 20px; cursor: pointer; }
    #preview { width: 100%; border-radius: 8px; margin-top: 15px; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    
    .btn { width: 100%; background: var(--accent); color: white; padding: 18px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; box-shadow: 0 4px 0px #278d57; }
    .btn:active { transform: translateY(2px); box-shadow: 0 2px 0px #278d57; }
    .btn:disabled { background: #ccc; box-shadow: none; transform: none; }
    #statusMsg { text-align: center; margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>

<div class="container">
  <h2>Site Completion</h2>
  <div id="jobDisplay" class="job-badge">Loading Job ID...</div>
  
  <div id="checklist">
    <label class="task-item"><input type="checkbox" class="task"> <span>Work area cleared of debris</span></label>
    <label class="task-item"><input type="checkbox" class="task"> <span>All tools accounted for</span></label>
    <label class="task-item"><input type="checkbox" class="task"> <span>Site secured / locked up</span></label>
    <label class="task-item"><input type="checkbox" class="task"> <span>Client notified of departure</span></label>
  </div>

  <div class="photo-section" onclick="document.getElementById('sitePhoto').click()">
    <p id="uploadText" style="margin:0; font-weight:bold; color:var(--primary);">ðŸ“¸ TAP TO CAPTURE FINISH PHOTO</p>
    <input type="file" id="sitePhoto" accept="image/*" capture="camera" style="display: none;">
    <img id="preview" alt="Site Preview">
  </div>

  <button id="submitBtn" class="btn" onclick="submitChecklist()">SUBMIT & VERIFY GPS</button>
  <p id="statusMsg"></p>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const email = urlParams.get('email');
  const jobId = urlParams.get('jobId') || "N/A";
  
  document.getElementById('jobDisplay').innerText = `Current Job: #${jobId}`;

  const scriptURL = 'https://script.google.com/macros/s/AKfycbzQT7DP6beojo_8pcOP3VFPcsBhvxI1nUYxbUQvThdnWuMvw8InEogp2TwoKS9RQ_M5/exec';

  // Handle Image Preview
  document.getElementById('sitePhoto').onchange = function(e) {
    const reader = new FileReader();
    reader.onload = function() {
      const preview = document.getElementById('preview');
      preview.src = reader.result;
      preview.style.display = 'block';
      document.getElementById('uploadText').innerText = "âœ… PHOTO READY";
    }
    reader.readAsDataURL(e.target.files[0]);
  };

  async function submitChecklist() {
    const tasks = document.querySelectorAll('.task');
    const allChecked = Array.from(tasks).every(t => t.checked);
    const photoFile = document.getElementById('sitePhoto').files[0];
    const btn = document.getElementById('submitBtn');
    const msg = document.getElementById('statusMsg');

    if (!allChecked || !photoFile) {
      alert("Mandatory: Check all boxes and take a photo before leaving.");
      return;
    }

    btn.innerText = "UPDATING DISPATCH...";
    btn.disabled = true;

    // Get GPS then Upload
    navigator.geolocation.getCurrentPosition(async (pos) => {
      const reader = new FileReader();
      reader.onload = async function() {
        const base64Data = reader.result.split(',')[1];
        
        const payload = {
          action: 'uploadJobPhoto',
          email: email,
          jobId: jobId,
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          fileData: base64Data,
          fileName: `Completion_${jobId}_${new Date().getTime()}.jpg`
        };

        try {
          const response = await fetch(scriptURL, { method: 'POST', body: JSON.stringify(payload) });
          
          msg.style.color = "green";
          msg.innerText = "âœ“ Site Verified! Redirecting...";
          
          setTimeout(() => {
            window.location.href = `../portal/dashboard.html?email=${encodeURIComponent(email)}`;
          }, 2000);

        } catch (err) {
          alert("Network error. Please try again.");
          btn.disabled = false;
          btn.innerText = "Submit & Verify GPS";
        }
      };
      reader.readAsDataURL(photoFile);
    }, (err) => {
      alert("GPS Permission Denied. You must be on-site to verify completion.");
      btn.disabled = false;
      btn.innerText = "Submit & Verify GPS";
    }, { enableHighAccuracy: true });
  }
</script>
</body>
</html>
