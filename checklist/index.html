<!DOCTYPE html>
<html>
<head>
    <title>Site Accountability | Well Done</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; }
        .task-box { text-align: left; max-width: 400px; margin: 20px auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px; }
        .btn-checkin { background-color: #33B26E; color: white; padding: 20px; width: 100%; border: none; border-radius: 5px; font-weight: bold; font-size: 1.2rem; cursor: pointer; }
        .btn-checkin:disabled { background-color: #ccc; }
    </style>
</head>
<body>

    <h2>Daily Site Checklist</h2>
    <div class="task-box">
        <label><input type="checkbox" class="task"> Site Cleaned</label><br><br>
        <label><input type="checkbox" class="task"> Photos Taken</label><br><br>
        <label><input type="checkbox" class="task"> Customer Updated</label>
    </div>

    <button id="btn" class="btn-checkin" onclick="startCheckIn()">Submit & Verify Location</button>
    <p id="status"></p>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');
        const scriptURL = 'https://script.google.com/macros/s/AKfycbx3JdShPWsv2leCEdh7Q7ebzbu3HZHXSGJgG3wgeKf7r2vvE-3YKKzHIiEmdTmIRZKg/exec';

        async function startCheckIn() {
            const tasks = document.querySelectorAll('.task');
            const allDone = Array.from(tasks).every(t => t.checked);

            if (!allDone) {
                alert("Please check all boxes first.");
                return;
            }

            document.getElementById('btn').disabled = true;
            document.getElementById('status').innerText = "Getting GPS...";

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const d = {
                    action: 'checkin',
                    email: email,
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude
                };

                await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(d) });
                
                document.getElementById('status').innerText = "Verified! Returning to Portal...";
                setTimeout(() => { window.location.href = `../portal/index.html?email=${email}`; }, 2000);

            }, (err) => {
                alert("GPS Error. Please enable location services.");
                document.getElementById('btn').disabled = false;
            });
        }
    </script>
</body>
</html>
