<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | Well Done Construction</title>
  <link rel="stylesheet" href="../styles.css">
  <style>
    .badge { padding: 6px 14px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; text-transform: uppercase; }
    .status-active { background: #33B26E; color: white; }
    .status-pending { background: #FFB800; color: #343E47; }
    .action-card { background: white; padding: 20px; border-radius: 12px; margin-top: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: left; }
    .logout-btn { background: none; border: 1px solid #ddd; color: #6E797F; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 40px; font-size: 0.9rem; }
  </style>
</head>
<body>

<div class="container" style="text-align: center; padding-top: 20px;">
    <h1 id="welcomeHeading">Loading...</h1>
    <div style="margin-bottom: 25px;">
      <span id="statusBadge" class="badge">Checking...</span>
    </div>
    
    <div id="activeContent" style="display:none;">
      <a href="#" id="checklistLink" class="btn" style="background: #33B26E; color: white; display: block; margin-bottom: 20px; text-decoration: none; padding: 15px; border-radius: 8px; font-weight: bold;">
        üìã START DAILY CHECKLIST
      </a>

      <div class="action-card">
        <h3 style="margin-top:0;">üì∏ Site Photo Upload</h3>
        <select id="photoType" style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px;">
          <option value="Address">üìç 1. Address Verification</option>
          <option value="Before">üõ†Ô∏è 2. Before Photo</option>
          <option value="After">‚úÖ 3. After Photo</option>
          <option value="Misc">üì¶ 4. Receipt/Misc</option>
        </select>
        <input type="file" id="photoFile" accept="image/*" capture="camera" style="margin-bottom: 15px; width: 100%;">
        <button onclick="uploadPhoto()" id="uploadBtn" class="btn" style="width: 100%; background: #343E47; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">UPLOAD TO DRIVE</button>
        <p id="uploadStatus" style="margin-top:10px; text-align: center; font-size: 0.9rem;"></p>
      </div>
    </div>

    <div id="pendingContent" style="display:none;" class="action-card">
      <h3>Account Pending</h3>
      <p>Management is currently reviewing your documents. Please ensure you have completed <a href="../onboarding.html">Onboarding</a>.</p>
    </div>

    <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyN1uUGRDmEYax-dyv5VB5xpzYGfKdQ8by-uMq82eBBUFjk3ETj9juCd9ax6E5IzWMt/exec';
    const urlParams = new URLSearchParams(window.location.search);
    const userEmail = urlParams.get('email');

    async function loadPortal() {
        if (!userEmail) { window.location.href = 'index.html'; return; }
        
        try {
            const resp = await fetch(`${scriptURL}?action=getWorkerStatus&email=${encodeURIComponent(userEmail)}`);
            const worker = await resp.json();
            
            document.getElementById('welcomeHeading').innerText = `Hello, ${worker.firstName || 'Worker'}!`;
            const badge = document.getElementById('statusBadge');
            badge.innerText = worker.status;

            // Updated logic to catch "ACTIVE / HIRED" which comes from the hireWorker function
            if (worker.status.includes('ACTIVE') || worker.status === 'ID UPLOADED') {
                badge.classList.add('status-active');
                document.getElementById('activeContent').style.display = 'block';
                document.getElementById('checklistLink').href = `../checklist/index.html?email=${encodeURIComponent(userEmail)}`;
            } else {
                badge.classList.add('status-pending');
                document.getElementById('pendingContent').style.display = 'block';
            }
        } catch (e) {
            document.getElementById('welcomeHeading').innerText = "Dashboard Offline";
        }
    }

    async function uploadPhoto() {
        const fileInput = document.getElementById('photoFile');
        const btn = document.getElementById('uploadBtn');
        const status = document.getElementById('uploadStatus');
        
        if (!fileInput.files[0]) return alert("Please capture an image.");

        btn.disabled = true;
        btn.innerText = "Uploading...";
        
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = async (e) => {
            const base64Data = e.target.result.split(',')[1];
            try {
                await fetch(scriptURL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        action: 'uploadJobPhoto',
                        email: userEmail,
                        fileData: base64Data,
                        fileType: file.type,
                        category: document.getElementById('photoType').value
                    })
                });
                status.style.color = "green";
                status.innerText = "‚úì Photo Saved!";
                fileInput.value = "";
            } catch (err) {
                status.style.color = "red";
                status.innerText = "Upload failed. Try again.";
            } finally {
                btn.disabled = false;
                btn.innerText = "UPLOAD ANOTHER";
            }
        };
        reader.readAsDataURL(file);
    }

    function logout() {
        if(confirm("Logout?")) window.location.href = 'index.html';
    }

    window.onload = loadPortal;
</script>
</body>
</html>
