<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Worker Portal | Well Done Construction</title>
  <link rel="stylesheet" href="../styles.css">
  <style>
    /* Portal Specific UI */
    .status-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    
    #photoUploadSection { 
      margin-top: 25px; 
      padding: 20px; 
      border: 2px dashed var(--wd-slate); 
      border-radius: 12px; 
      background: #fff; 
    }

    /* Preview Image Styling */
    #lastPhotoPreview {
      width: 100%;
      max-height: 250px;
      border-radius: 8px;
      margin-top: 10px;
      object-fit: cover;
      border: 3px solid var(--wd-green);
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--wd-green);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div class="container" style="text-align: center;">
  <div id="loader">
    <div class="loading-spinner"></div>
    <p>Opening your portal...</p>
  </div>

  <div id="mainUI" style="display:none;">
    <h1 id="welcomeHeading" style="margin-bottom: 5px;">---</h1>
    <div style="margin-bottom: 25px;">
      <span id="statusBadge" class="badge">Checking Status...</span>
    </div>
    
    <div id="activeContent" style="display:none;">
      <a href="#" id="checklistLink" class="btn" style="background: var(--wd-green); color: white;">
        üìã START DAILY CHECKLIST
      </a>

      <div id="photoUploadSection">
        <h3 style="margin-top:0;">üì∏ Site Photo Upload</h3>
        <p style="font-size: 0.85rem; color: var(--wd-slate); margin-bottom: 15px;">Required: Address, Before, and After photos.</p>
        
        <select id="photoType">
          <option value="Address">üìç 1. Address Verification</option>
          <option value="Before">üõ†Ô∏è 2. Before Photo</option>
          <option value="After">‚úÖ 3. After Photo</option>
          <option value="Progress">üîÑ 4. Progress/Misc</option>
        </select>

        <input type="file" id="photoFile" accept="image/*" capture="camera">
        
        <button onclick="uploadPhoto()" id="uploadBtn" class="btn" style="background: var(--wd-dark); color: white; margin-top: 10px;">
          üì§ UPLOAD TO PROJECT FOLDER
        </button>
        
        <p id="uploadStatus" style="font-size: 0.9rem; margin-top: 10px; font-weight: bold;"></p>

        <div id="photoPreviewContainer" style="display:none;">
          <p style="font-size: 0.8rem; color: var(--wd-slate); margin-bottom: 5px;">Last Successfully Uploaded:</p>
          <img id="lastPhotoPreview" src="">
        </div>
      </div>
    </div>

    <div id="pendingContent" style="display:none; padding: 40px 20px;">
      <p style="font-size: 1.2rem; color: var(--wd-slate);">Your account is currently <strong>Pending</strong>.</p>
      <p>Please ensure you have completed <a href="../onboarding.html" style="color: var(--wd-green); font-weight: bold;">Onboarding</a>. Once management approves your ID, your portal will activate.</p>
    </div>
  </div>
</div>

<nav class="nav-dock">
  <a href="../index.html">Home</a>
  <a href="../application/index.html">Intake</a>
  <a href="../onboarding.html">Onboarding</a>
  <a href="index.html" class="active">Portal</a>
</nav>

<script>
  const scriptURL = 'https://script.google.com/macros/s/AKfycbx3JdShPWsv2leCEdh7Q7ebzbu3HZHXSGJgG3wgeKf7r2vvE-3YKKzHIiEmdTmIRZKg/exec';
  let userEmail = "";

  async function loadPortal() {
    const urlParams = new URLSearchParams(window.location.search);
    userEmail = urlParams.get('email');

    if (!userEmail) {
      alert("Please log in with your email.");
      window.location.href = '../index.html';
      return;
    }

    try {
      // Fetch worker status from Google Sheet
      const response = await fetch(`${scriptURL}?email=${encodeURIComponent(userEmail)}&action=getWorkerStatus`);
      const worker = await response.json();

      document.getElementById('loader').style.display = 'none';
      document.getElementById('mainUI').style.display = 'block';

      if (worker.status === 'Not Found') {
        alert('No profile found for this email. Please apply first.');
        window.location.href = '../application/index.html';
        return;
      }

      document.getElementById('welcomeHeading').innerText = `Hello, ${worker.firstName}!`;
      const badge = document.getElementById('statusBadge');
      badge.innerText = worker.status;

      if (worker.status === 'ACTIVE') {
        badge.className = 'badge status-active';
        document.getElementById('activeContent').style.display = 'block';
        document.getElementById('checklistLink').href = `../checklist/index.html?email=${encodeURIComponent(userEmail)}`;
      } else {
        badge.className = 'badge status-pending';
        document.getElementById('pendingContent').style.display = 'block';
      }
      
    } catch (err) {
      console.error(err);
      document.getElementById('loader').innerHTML = "<p style='color:red;'>Connection Error. Please refresh.</p>";
    }
  }

  async function uploadPhoto() {
    const fileInput = document.getElementById('photoFile');
    const type = document.getElementById('photoType').value;
    const status = document.getElementById('uploadStatus');
    const btn = document.getElementById('uploadBtn');
    const previewImg = document.getElementById('lastPhotoPreview');
    const previewContainer = document.getElementById('photoPreviewContainer');

    if (!fileInput.files[0]) return alert("Please take a photo first.");

    btn.disabled = true;
    btn.innerText = "‚è≥ SENDING TO DRIVE...";
    status.style.color = "#343E47";
    status.innerText = "Uploading to project folder...";

    const file = fileInput.files[0];
    const reader = new FileReader();

    reader.onload = async (e) => {
      const base64Data = e.target.result.split(',')[1];
      const payload = {
        action: 'uploadJobPhoto',
        email: userEmail, 
        fileData: base64Data,
        fileType: file.type,
        category: type
      };

      try {
        await fetch(scriptURL, {
          method: 'POST',
          mode: 'no-cors',
          body: JSON.stringify(payload)
        });

        // UI Update on Success
        previewImg.src = e.target.result;
        previewContainer.style.display = 'block';
        status.style.color = "green";
        status.innerText = "‚úÖ " + type + " photo saved successfully!";
        fileInput.value = ""; 
      } catch (err) {
        status.style.color = "red";
        status.innerText = "Upload failed. Check signal and try again.";
      } finally {
        btn.disabled = false;
        btn.innerText = "üì§ UPLOAD ANOTHER PHOTO";
      }
    };
    reader.readAsDataURL(file);
  }

  window.onload = loadPortal;
</script>

</body>
</html>
